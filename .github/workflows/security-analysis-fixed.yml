name: Security Analysis

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Run weekly security scans
    - cron: '0 0 * * 0'

jobs:
  # Stage 1: Linting & Style
  lint:
    name: Linting & Style Checks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install elan
      run: |
        curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y
        echo "$HOME/.elan/bin" >> $GITHUB_PATH

    - name: Lean 4 Linter
      run: |
        echo "Running Lean 4 linter..."
        lake build 2>&1 | grep -E "warning|error" || echo "✓ No linter warnings"

    - name: Check for unused variables
      run: |
        echo "Checking for unused variables..."
        if lake build 2>&1 | grep -q "unused variable"; then
          echo "⚠ Found unused variables (check build output above)"
          lake build 2>&1 | grep "unused variable" || true
        else
          echo "✓ No unused variable warnings"
        fi

  # Stage 2: Static Analysis
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Semgrep (Security & FFI Safety)
      uses: returntocorp/semgrep-action@v1
      with:
        config: >-
          p/security
          .semgrep.yml
        fail_on_error: false
      env:
        SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
      continue-on-error: true

    # CodeQL: Skip for now since Lean 4 isn't supported
    # When Lean 4 support is added, uncomment and configure:
    # - name: Initialize CodeQL
    #   uses: github/codeql-action/init@v3
    #   with:
    #     languages: cpp  # Analyze generated C code for now
    #   continue-on-error: true
    #
    # - name: Perform CodeQL Analysis
    #   uses: github/codeql-action/analyze@v3
    #   continue-on-error: true

    - name: Dependency Scan (Snyk)
      uses: snyk/actions/setup@master
      continue-on-error: true

    - name: Run Snyk test
      uses: snyk/actions/test@master
      continue-on-error: true
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high

  # Stage 3: Formal Verification
  formal-verification:
    name: Formal Verification
    runs-on: ubuntu-latest
    needs: [lint]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install elan
      run: |
        curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y
        echo "$HOME/.elan/bin" >> $GITHUB_PATH

    - name: Build with strict checking
      run: |
        lake build

    - name: Verify no sorry
      run: |
        echo "Checking for incomplete proofs..."
        SORRY_COUNT=$(grep -r "sorry" ZkIpProtocol/ Tests/ Main.lean 2>/dev/null | grep -v "^Binary" | grep -v "test" | wc -l)
        if [ "$SORRY_COUNT" -gt 0 ]; then
          echo "✗ Found $SORRY_COUNT incomplete proofs"
          grep -r "sorry" ZkIpProtocol/ Tests/ Main.lean 2>/dev/null | grep -v "^Binary" | grep -v "test"
          exit 1
        else
          echo "✓ No incomplete proofs found"
        fi

    - name: Verify termination proofs
      run: |
        echo "Checking for termination_by clauses..."
        # This is a basic check - full verification happens during compilation
        lake build 2>&1 | grep -E "termination|decreasing" || echo "✓ Termination proofs verified during compilation"

  # Stage 4: Security-Specific Checks
  security-checks:
    name: Security-Specific Validation
    runs-on: ubuntu-latest
    needs: [static-analysis]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check private/public input separation
      run: |
        echo "Verifying private/public input separation in STARKIntegration..."
        # Check that privateInputs and publicInputs are clearly separated
        if grep -q "privateInputs" ZkIpProtocol/STARKIntegration.lean && \
           grep -q "publicInputs" ZkIpProtocol/STARKIntegration.lean; then
          echo "✓ Private and public inputs are clearly separated"
        else
          echo "⚠ Warning: Could not verify input separation"
        fi

        # Verify SecurityValidation is used in Api.lean
        if grep -q "SecurityValidation" ZkIpProtocol/Api.lean; then
          echo "✓ SecurityValidation namespace found in Api.lean"
        else
          echo "✗ ERROR: SecurityValidation not found in Api.lean"
          exit 1
        fi

    - name: Check for hardcoded secrets
      run: |
        echo "Scanning for potential secrets..."
        # Basic check - more sophisticated tools available
        if grep -riE "(password|secret|key|token)\s*[:=]\s*['\"][^'\"]+['\"]" ZkIpProtocol/ Main.lean 2>/dev/null | grep -v "test" | grep -v "TODO"; then
          echo "⚠ Warning: Potential hardcoded secrets found"
          grep -riE "(password|secret|key|token)\s*[:=]\s*['\"][^'\"]+['\"]" ZkIpProtocol/ Main.lean 2>/dev/null | grep -v "test" | grep -v "TODO" || true
        else
          echo "✓ No obvious hardcoded secrets found"
        fi

  # Stage 5: Review Synthesis (CodeRabbit) - Simplified
  review-synthesis:
    name: Review Synthesis
    runs-on: ubuntu-latest
    needs: [lint, static-analysis, formal-verification, security-checks]
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # CodeRabbit: Using the official action (simplified configuration)
    - name: CodeRabbit Review
      uses: coderabbitai/pr-agent@latest
      if: github.event_name == 'pull_request'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true

    - name: Summarize Findings
      run: |
        echo "## Security Analysis Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Tools Executed:" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Lean 4 / Lake: Formal verification" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Semgrep: FFI safety and security patterns" >> $GITHUB_STEP_SUMMARY
        echo "- ⚠️ CodeQL: Skipped (Lean 4 support pending)" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ CodeRabbit: Review synthesis" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "See individual job outputs for detailed findings." >> $GITHUB_STEP_SUMMARY

